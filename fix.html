<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>修复游戏</title>
    <style>
        body { 
            background: #667eea; 
            color: white; 
            font-family: Arial; 
            text-align: center; 
            padding: 50px; 
        }
        button { 
            padding: 15px 30px; 
            font-size: 18px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px;
        }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <h1>🔧 游戏修复工具</h1>
    <p>点击下面的按钮来修复游戏状态</p>
    
    <button onclick="forceAITurn()">🤖 强制AI执行回合</button>
    <button onclick="switchToPlayer()">👤 切换到玩家回合</button>
    <button onclick="restartGame()">🔄 重新开始游戏</button>
    <button onclick="window.open('index.html', '_blank')">🎮 打开新游戏</button>
    
    <div id="status" style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;"></div>

    <script>
        // 获取父窗口的游戏实例
        function getGameInstance() {
            if (window.opener && window.opener.dragonTigerGame) {
                return window.opener.dragonTigerGame;
            }
            return null;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        async function forceAITurn() {
            const game = getGameInstance();
            if (!game) {
                updateStatus('❌ 找不到游戏实例，请确保从主游戏页面打开此页面');
                return;
            }

            try {
                updateStatus('🤖 正在执行AI回合...');
                const result = await game.gameEngine.executeAITurn();
                if (result.success) {
                    updateStatus('✅ AI回合执行成功！请返回游戏页面查看');
                } else {
                    updateStatus('❌ AI回合执行失败：' + result.error?.message);
                }
            } catch (error) {
                updateStatus('❌ 执行错误：' + error.message);
            }
        }

        function switchToPlayer() {
            const game = getGameInstance();
            if (!game) {
                updateStatus('❌ 找不到游戏实例');
                return;
            }

            try {
                game.gameEngine.gameState.currentPlayer = 'player';
                updateStatus('✅ 已切换到玩家回合！请返回游戏页面');
            } catch (error) {
                updateStatus('❌ 切换失败：' + error.message);
            }
        }

        function restartGame() {
            const game = getGameInstance();
            if (!game) {
                updateStatus('❌ 找不到游戏实例');
                return;
            }

            try {
                const result = game.gameEngine.restartGame();
                updateStatus('✅ 游戏已重启！请返回游戏页面');
            } catch (error) {
                updateStatus('❌ 重启失败：' + error.message);
            }
        }

        // 页面加载时检查游戏状态
        window.onload = function() {
            const game = getGameInstance();
            if (game) {
                const gameState = game.gameEngine.gameState;
                updateStatus(`
                    📊 游戏状态：<br>
                    阶段：${gameState.phase}<br>
                    当前玩家：${gameState.currentPlayer}<br>
                    玩家阵营：${gameState.playerFaction}<br>
                    AI阵营：${gameState.aiFaction}
                `);
            } else {
                updateStatus('⚠️ 未找到游戏实例。请从主游戏页面打开此修复工具。');
            }
        };
    </script>
</body>
</html>
