<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾™è™æ–— - è°ƒè¯•ç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        
        .game-board {
            display: grid;
            grid-template-rows: repeat(5, 120px);
            grid-template-columns: repeat(4, 90px);
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin: 20px auto;
            width: fit-content;
        }
        
        .board-cell {
            background: #ecf0f1;
            border: 2px solid #95a5a6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .board-cell.empty-row {
            background: #34495e;
            cursor: default;
        }
        
        .card {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-align: center;
        }
        
        /* å…³é”®ï¼šèƒŒé¢å¡ç‰Œæ ·å¼ */
        .card.back {
            background: white url('assets/cards/card_back.png') center/cover no-repeat !important;
            color: transparent !important;
        }
        
        /* å…³é”®ï¼šæ­£é¢å¡ç‰Œæ ·å¼ */
        .card.front {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            color: transparent !important;
            font-weight: bold;
        }
        
        .card.front .card-name {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            text-align: center;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .log {
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .test-section {
            border: 1px solid #555;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ‰ é¾™è™æ–— - è°ƒè¯•ç‰ˆ ğŸ…</h1>
    
    <div class="test-section">
        <h3>1. å›¾ç‰‡æµ‹è¯•</h3>
        <button class="button" onclick="testBackImage()">æµ‹è¯•èƒŒé¢å›¾ç‰‡</button>
        <button class="button" onclick="testFrontImages()">æµ‹è¯•æ­£é¢å›¾ç‰‡</button>
        <div id="image-test-area" style="display: flex; gap: 10px; margin: 10px 0;"></div>
    </div>
    
    <div class="test-section">
        <h3>2. æ£‹ç›˜æµ‹è¯•</h3>
        <button class="button" onclick="createTestBoard()">åˆ›å»ºæµ‹è¯•æ£‹ç›˜</button>
        <button class="button" onclick="addTestCards()">æ·»åŠ æµ‹è¯•å¡ç‰Œ</button>
        <button class="button" onclick="flipAllCards()">ç¿»è½¬æ‰€æœ‰å¡ç‰Œ</button>
        
        <div id="game-board" class="game-board">
            <!-- æ£‹ç›˜å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
    </div>
    
    <div class="test-section">
        <h3>3. æ¸¸æˆå¼•æ“æµ‹è¯•</h3>
        <button class="button" onclick="testGameEngine()">æµ‹è¯•æ¸¸æˆå¼•æ“</button>
        <button class="button" onclick="startRealGame()">å¯åŠ¨çœŸå®æ¸¸æˆ</button>
    </div>
    
    <div class="log" id="log">
        <div>è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <script type="module">
        // å¯¼å…¥æ¸¸æˆå¼•æ“
        import { GameEngine } from './scripts/core/GameEngine.js';
        
        let gameEngine = null;
        let testCards = [];
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${time}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // 1. æµ‹è¯•èƒŒé¢å›¾ç‰‡
        window.testBackImage = function() {
            log('ğŸ” æµ‹è¯•èƒŒé¢å›¾ç‰‡...');
            
            const testArea = document.getElementById('image-test-area');
            testArea.innerHTML = '';
            
            // æ–¹æ³•1: CSSèƒŒæ™¯
            const cssTest = document.createElement('div');
            cssTest.style.width = '80px';
            cssTest.style.height = '112px';
            cssTest.style.background = 'url("assets/cards/card_back.png") center/cover no-repeat';
            cssTest.style.border = '2px solid yellow';
            cssTest.title = 'CSSèƒŒæ™¯';
            testArea.appendChild(cssTest);
            
            // æ–¹æ³•2: IMGæ ‡ç­¾
            const imgTest = document.createElement('img');
            imgTest.src = 'assets/cards/card_back.png?t=' + Date.now();
            imgTest.style.width = '80px';
            imgTest.style.height = '112px';
            imgTest.style.border = '2px solid green';
            imgTest.title = 'IMGæ ‡ç­¾';
            imgTest.onload = () => log('âœ… IMGæ ‡ç­¾åŠ è½½æˆåŠŸ');
            imgTest.onerror = () => log('âŒ IMGæ ‡ç­¾åŠ è½½å¤±è´¥');
            testArea.appendChild(imgTest);
            
            log('ğŸ” èƒŒé¢å›¾ç‰‡æµ‹è¯•å·²åˆ›å»º');
        };
        
        // 2. æµ‹è¯•æ­£é¢å›¾ç‰‡
        window.testFrontImages = function() {
            log('ğŸ” æµ‹è¯•æ­£é¢å›¾ç‰‡...');
            
            const testArea = document.getElementById('image-test-area');
            testArea.innerHTML = '';
            
            const testImages = [
                'dragon_1.png',
                'dragon_8.png', 
                'tiger_1.png', 
                'tiger_8.png'
            ];
            
            testImages.forEach(imageName => {
                const imgTest = document.createElement('img');
                imgTest.src = `assets/cards/${imageName}?t=${Date.now()}`;
                imgTest.style.width = '60px';
                imgTest.style.height = '84px';
                imgTest.style.border = '1px solid white';
                imgTest.style.margin = '2px';
                imgTest.title = imageName;
                imgTest.onload = () => log(`âœ… ${imageName} åŠ è½½æˆåŠŸ`);
                imgTest.onerror = () => log(`âŒ ${imageName} åŠ è½½å¤±è´¥`);
                testArea.appendChild(imgTest);
            });
        };
        
        // 3. åˆ›å»ºæµ‹è¯•æ£‹ç›˜
        window.createTestBoard = function() {
            log('ğŸ¨ åˆ›å»ºæµ‹è¯•æ£‹ç›˜...');
            
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    if (row === 2) {
                        cell.classList.add('empty-row');
                        cell.textContent = 'âš¡';
                    } else {
                        cell.addEventListener('click', () => handleCellClick(row, col));
                        cell.textContent = `${row},${col}`;
                    }
                    
                    board.appendChild(cell);
                }
            }
            
            log(`âœ… æ£‹ç›˜åˆ›å»ºå®Œæˆï¼Œå…±${4*4}ä¸ªæœ‰æ•ˆæ ¼å­`);
        };
        
        // 4. æ·»åŠ æµ‹è¯•å¡ç‰Œ
        window.addTestCards = function() {
            log('ğŸƒ æ·»åŠ æµ‹è¯•å¡ç‰Œ...');
            
            const cells = document.querySelectorAll('.board-cell:not(.empty-row)');
            testCards = [];
            
            cells.forEach((cell, index) => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                
                const card = document.createElement('div');
                card.className = 'card back';
                card.dataset.cardIndex = index;
                card.dataset.flipped = 'false';
                
                // é¢„è®¾å¡ç‰Œæ•°æ®
                const faction = index % 2 === 0 ? 'dragon' : 'tiger';
                const level = (index % 8) + 1;
                card.dataset.faction = faction;
                card.dataset.level = level;
                
                cell.innerHTML = '';
                cell.appendChild(card);
                
                testCards.push({
                    element: card,
                    faction: faction,
                    level: level,
                    isFlipped: false
                });
            });
            
            log(`âœ… æ·»åŠ äº†${testCards.length}å¼ æµ‹è¯•å¡ç‰Œ`);
        };
        
        // 5. ç¿»è½¬æ‰€æœ‰å¡ç‰Œ
        window.flipAllCards = function() {
            log('ğŸ”„ ç¿»è½¬æ‰€æœ‰å¡ç‰Œ...');
            
            testCards.forEach((cardData, index) => {
                setTimeout(() => {
                    flipCard(cardData);
                }, index * 200); // é€ä¸ªç¿»è½¬
            });
        };
        
        // ç¿»è½¬å•å¼ å¡ç‰Œ
        function flipCard(cardData) {
            const card = cardData.element;
            
            if (cardData.isFlipped) {
                // ç¿»å›èƒŒé¢
                card.className = 'card back';
                card.style.backgroundImage = '';
                card.innerHTML = '';
                cardData.isFlipped = false;
                log(`ğŸ´ å¡ç‰Œç¿»å›èƒŒé¢`);
            } else {
                // ç¿»åˆ°æ­£é¢ - ä½¿ç”¨ä¸ç®€åŒ–ç‰ˆç›¸åŒçš„æ–¹æ³•
                card.className = 'card front';
                const imagePath = `assets/cards/${cardData.faction}_${cardData.level}.png?t=${Date.now()}`;
                card.style.backgroundImage = `url('${imagePath}')`;
                
                // æ¸…ç©ºå†…å®¹
                card.innerHTML = '';
                
                // åˆ›å»ºå¡ç‰Œä¿¡æ¯è¦†ç›–å±‚ - ä½¿ç”¨ä¸ç®€åŒ–ç‰ˆç›¸åŒçš„ç±»å
                const infoDiv = document.createElement('div');
                infoDiv.className = 'card-name';
                infoDiv.textContent = `${cardData.faction}_${cardData.level}`;
                card.appendChild(infoDiv);
                
                cardData.isFlipped = true;
                log(`ğŸƒ å¡ç‰Œç¿»åˆ°æ­£é¢: ${cardData.faction}_${cardData.level} (${imagePath})`);
            }
        }
        
        // å¤„ç†æ ¼å­ç‚¹å‡»
        function handleCellClick(row, col) {
            log(`ğŸ” ç‚¹å‡»äº†ä½ç½® (${row}, ${col})`);
            
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            const card = cell.querySelector('.card');
            
            if (card) {
                const index = parseInt(card.dataset.cardIndex);
                if (testCards[index]) {
                    flipCard(testCards[index]);
                }
            } else {
                log('âš ï¸ è¯¥ä½ç½®æ²¡æœ‰å¡ç‰Œ');
            }
        }
        
        // 6. æµ‹è¯•æ¸¸æˆå¼•æ“
        window.testGameEngine = function() {
            log('ğŸ® æµ‹è¯•æ¸¸æˆå¼•æ“...');
            
            try {
                gameEngine = new GameEngine();
                log('âœ… æ¸¸æˆå¼•æ“åˆ›å»ºæˆåŠŸ');
                
                const result = gameEngine.startNewGame();
                if (result.success) {
                    log('âœ… æ¸¸æˆå¯åŠ¨æˆåŠŸ');
                    log(`ğŸ“Š æ¸¸æˆçŠ¶æ€: ${gameEngine.gameState.phase}`);
                    log(`ğŸƒ å¡ç‰Œæ•°é‡: ${gameEngine.gameState.cardsData.length}`);
                    
                    // ç¡®ä¿æ¸¸æˆçŠ¶æ€æ­£ç¡®
                    if (gameEngine.gameState.phase !== 'playing') {
                        log('âš ï¸ æ¸¸æˆçŠ¶æ€ä¸æ­£ç¡®ï¼Œæ‰‹åŠ¨è®¾ç½®ä¸ºplaying');
                        gameEngine.gameState.phase = 'playing';
                    }
                    
                    const boardResult = gameEngine.initializeBoard();
                    if (boardResult && boardResult.success) {
                        log('âœ… æ£‹ç›˜åˆå§‹åŒ–æˆåŠŸ');
                        log(`ğŸ“Š æ›´æ–°åæ¸¸æˆçŠ¶æ€: ${gameEngine.gameState.phase}`);
                    } else {
                        log(`âŒ æ£‹ç›˜åˆå§‹åŒ–å¤±è´¥: ${boardResult?.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } else {
                    log(`âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥: ${result.error?.message}`);
                }
                
            } catch (error) {
                log(`âŒ æ¸¸æˆå¼•æ“æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('GameEngine test error:', error);
            }
        };
        
        // 7. å¯åŠ¨çœŸå®æ¸¸æˆ
        window.startRealGame = function() {
            log('ğŸš€ å¯åŠ¨çœŸå®æ¸¸æˆ...');
            
            if (!gameEngine) {
                log('âš ï¸ è¯·å…ˆæµ‹è¯•æ¸¸æˆå¼•æ“');
                return;
            }
            
            // è®¾ç½®ä¸ºç©å®¶å›åˆ
            gameEngine.gameState.currentPlayer = 'player';
            log('ğŸ¯ è®¾ç½®ä¸ºç©å®¶å›åˆ');
            log(`ğŸ“Š å½“å‰ç©å®¶: ${gameEngine.gameState.currentPlayer}`);
            
            // æ¸…ç©ºæ£‹ç›˜
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            
            // é‡æ–°åˆ›å»ºæ£‹ç›˜
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 4; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'board-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    if (row === 2) {
                        cell.classList.add('empty-row');
                        cell.textContent = 'âš¡';
                    } else {
                        cell.addEventListener('click', () => handleRealCellClick(row, col));
                    }
                    
                    board.appendChild(cell);
                }
            }
            
            // æ¸²æŸ“çœŸå®å¡ç‰Œ
            renderRealBoard();
        };
        
        function renderRealBoard() {
            log('ğŸ¨ æ¸²æŸ“çœŸå®æ¸¸æˆæ£‹ç›˜...');
            
            const gameState = gameEngine.gameState;
            
            gameState.cardsData.forEach(card => {
                if (card.position.row >= 0 && card.position.col >= 0) {
                    const cell = document.querySelector(`[data-row="${card.position.row}"][data-col="${card.position.col}"]`);
                    if (cell) {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card';
                        
                        if (card.isRevealed) {
                            cardElement.classList.add('front');
                            const imagePath = `assets/cards/${card.faction}_${card.level}.png?t=${Date.now()}`;
                            cardElement.style.backgroundImage = `url('${imagePath}')`;
                            
                            // åˆ›å»ºå¡ç‰Œåç§°æ ‡ç­¾
                            const nameLabel = document.createElement('div');
                            nameLabel.className = 'card-name';
                            nameLabel.textContent = card.name;
                            cardElement.appendChild(nameLabel);
                            
                            log(`ğŸƒ æ¸²æŸ“å·²ç¿»å¼€å¡ç‰Œ: ${card.name} (${imagePath})`);
                        } else {
                            cardElement.classList.add('back');
                            log(`ğŸ´ æ¸²æŸ“èƒŒé¢å¡ç‰Œ at (${card.position.row}, ${card.position.col})`);
                        }
                        
                        cell.appendChild(cardElement);
                    }
                }
            });
            
            log('ğŸ¨ çœŸå®æ£‹ç›˜æ¸²æŸ“å®Œæˆ');
        }
        
        function handleRealCellClick(row, col) {
            log(`ğŸ” çœŸå®æ¸¸æˆç‚¹å‡»: (${row}, ${col})`);
            
            const gameState = gameEngine.gameState;
            const card = gameState.getCardAt(row, col);
            
            if (card && !card.isRevealed) {
                log('ğŸ¯ å°è¯•ç¿»ç‰Œ...');
                const result = gameEngine.flipCard(row, col);
                
                if (result.success) {
                    log(`âœ… ç¿»ç‰ŒæˆåŠŸ: ${result.data.flippedCard.name}`);
                    renderRealBoard();
                } else {
                    log(`âŒ ç¿»ç‰Œå¤±è´¥: ${result.error?.message}`);
                }
            } else if (card) {
                log('âš ï¸ å¡ç‰Œå·²ç»ç¿»å¼€');
            } else {
                log('âš ï¸ è¯¥ä½ç½®æ²¡æœ‰å¡ç‰Œ');
            }
        }
        
        // åˆå§‹åŒ–
        log('ğŸš€ è°ƒè¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>
